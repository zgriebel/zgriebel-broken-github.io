<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Zach">
<meta name="dcterms.date" content="2023-10-09">

<title>Classification Modeling</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="PS4_files/libs/clipboard/clipboard.min.js"></script>
<script src="PS4_files/libs/quarto-html/quarto.js"></script>
<script src="PS4_files/libs/quarto-html/popper.min.js"></script>
<script src="PS4_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="PS4_files/libs/quarto-html/anchor.min.js"></script>
<link href="PS4_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="PS4_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="PS4_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="PS4_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="PS4_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Classification Modeling</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Zach </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">October 9, 2023</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<p>Classification means when the prediction is not a statistical number. In this case the prediction a category. The NVO case has the prediction being if a person responds to mailing which is a category.</p>
<p>The benefit of using modeling would be to focus resources on opportunities with higher potential. If a model can find people with a higher chance of responding the resources can be focused there.</p>
<p>The most important for evaluating these models is Precision and Sensitivity. Precision(Pos pred values) the model says yes, how often is that correct. We are looking to identify potential Yes. We want to utilize our resources on correct yes responses. Sensitivity is the rate of true positives captured by the program.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rpart)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(caret)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">suppressWarnings</span>(</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(DALEX))</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggthemes)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pROC)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(corrplot)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(glmnet)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>donor <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">'donors.csv'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(donor)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 95,412
Columns: 22
$ age                     &lt;int&gt; 60, 46, NA, 70, 78, NA, 38, NA, NA, 65, NA, 75~
$ numberChildren          &lt;int&gt; NA, 1, NA, NA, 1, NA, 1, NA, NA, NA, NA, NA, 2~
$ incomeRating            &lt;int&gt; NA, 6, 3, 1, 3, NA, 4, 2, 3, NA, 2, 1, 4, NA, ~
$ wealthRating            &lt;int&gt; NA, 9, 1, 4, 2, NA, 6, 9, 2, NA, 0, 5, 2, NA, ~
$ mailOrderPurchases      &lt;int&gt; 0, 16, 2, 2, 60, 0, 0, 1, 0, 0, 0, 3, 16, 0, 1~
$ totalGivingAmount       &lt;dbl&gt; 240, 47, 202, 109, 254, 51, 107, 31, 199, 28, ~
$ numberGifts             &lt;int&gt; 31, 3, 27, 16, 37, 4, 14, 5, 11, 3, 1, 2, 9, 1~
$ smallestGiftAmount      &lt;dbl&gt; 5, 10, 2, 2, 3, 10, 3, 5, 10, 3, 20, 10, 4, 5,~
$ largestGiftAmount       &lt;dbl&gt; 12, 25, 16, 11, 15, 16, 12, 11, 22, 15, 20, 15~
$ averageGiftAmount       &lt;dbl&gt; 7.741935, 15.666667, 7.481481, 6.812500, 6.864~
$ yearsSinceFirstDonation &lt;int&gt; 8, 3, 7, 10, 11, 3, 10, 3, 9, 3, 1, 1, 8, 5, 4~
$ monthsSinceLastDonation &lt;int&gt; 14, 14, 14, 14, 13, 20, 22, 18, 19, 22, 12, 14~
$ inHouseDonor            &lt;lgl&gt; FALSE, FALSE, FALSE, FALSE, TRUE, FALSE, FALSE~
$ plannedGivingDonor      &lt;lgl&gt; FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALS~
$ sweepstakesDonor        &lt;lgl&gt; FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALS~
$ P3Donor                 &lt;lgl&gt; FALSE, FALSE, FALSE, FALSE, TRUE, FALSE, FALSE~
$ state                   &lt;chr&gt; "IL", "CA", "NC", "CA", "FL", "AL", "IN", "LA"~
$ urbanicity              &lt;chr&gt; "town", "suburb", "rural", "rural", "suburb", ~
$ socioEconomicStatus     &lt;chr&gt; "average", "highest", "average", "average", "a~
$ isHomeowner             &lt;lgl&gt; NA, TRUE, NA, NA, TRUE, NA, TRUE, NA, NA, NA, ~
$ gender                  &lt;chr&gt; "female", "male", "male", "female", "female", ~
$ respondedMailing        &lt;lgl&gt; FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALS~</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sapply</span>(donor, <span class="cf">function</span>(x) <span class="fu">sum</span>(<span class="fu">is.na</span>(x)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                    age          numberChildren            incomeRating 
                  23665                   83026                   21286 
           wealthRating      mailOrderPurchases       totalGivingAmount 
                  44732                       0                       0 
            numberGifts      smallestGiftAmount       largestGiftAmount 
                      0                       0                       0 
      averageGiftAmount yearsSinceFirstDonation monthsSinceLastDonation 
                      0                       0                       0 
           inHouseDonor      plannedGivingDonor        sweepstakesDonor 
                      0                       0                       0 
                P3Donor                   state              urbanicity 
                      0                       0                    2316 
    socioEconomicStatus             isHomeowner                  gender 
                   2316                   43058                    4676 
       respondedMailing 
                      0 </code></pre>
</div>
</div>
<p>We see there are 22 variables and 95,412 observations. Many are numeric however there are a few that need to be adjusted to be factors. There are logical columns, those will also be mutated to be factors.</p>
<p>There are 83,000 NAs with children. For that reason I will drop that column, that is to many NAs to make an assumption to make decisions from.</p>
<p>It can be assumed that <code>incomeRating</code> and <code>Welathrating</code> derive from <code>eachother</code>. Wealth rating has a lot more NAs so we will drop that column as well.</p>
<p>If home owner is NA it will be assumed that the answer is False</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>donor <span class="ot">=</span> donor <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>numberChildren, <span class="sc">-</span>wealthRating, <span class="sc">-</span>urbanicity, <span class="sc">-</span>gender, <span class="sc">-</span>state, <span class="sc">-</span> socioEconomicStatus)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>donor <span class="ot">=</span> donor <span class="sc">%&gt;%</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">incomeRating =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(incomeRating),</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>                                 <span class="dv">4</span>,</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>                                 incomeRating))</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>donor <span class="ot">=</span> donor <span class="sc">%&gt;%</span> </span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">isHomeowner =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(isHomeowner),</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>                              <span class="cn">FALSE</span>,</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>                              isHomeowner))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>donor <span class="ot">=</span> donor <span class="sc">%&gt;%</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">respondedMailing =</span> <span class="fu">as.factor</span>(<span class="fu">as.numeric</span>(respondedMailing))) <span class="sc">%&gt;%</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">isHomeowner =</span> <span class="fu">as.numeric</span>(isHomeowner))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This is setting our response variable to a factor</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(corrplot)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="fu">na.omit</span>(donor) <span class="sc">%&gt;%</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">keep</span>(is.numeric) <span class="sc">%&gt;%</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cor</span>() <span class="sc">%&gt;%</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">corrplot</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="PS4_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>There are a couple interesting correlations here. <code>Total Giving Amount</code> and <code>Number of Gifts</code> are strongly correlated which makes sense. <code>Smallest Gift</code> and <code>Number of Gifts</code> are correlated. That make sense because for example is a donor gives quite often the avarage size of the donation would be smaller because it is more frequent. <code>Years Since First donation</code> and <code>Total Giving Amount</code> makes sense. The longer you have been a donor the more you will have donated. <code>Average Gift</code> is correlated with the statistics with largest and smallest gift.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sapply</span>(donor, <span class="cf">function</span>(x) <span class="fu">sum</span>(<span class="fu">is.na</span>(x)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                    age            incomeRating      mailOrderPurchases 
                  23665                       0                       0 
      totalGivingAmount             numberGifts      smallestGiftAmount 
                      0                       0                       0 
      largestGiftAmount       averageGiftAmount yearsSinceFirstDonation 
                      0                       0                       0 
monthsSinceLastDonation            inHouseDonor      plannedGivingDonor 
                      0                       0                       0 
       sweepstakesDonor                 P3Donor             isHomeowner 
                      0                       0                       0 
       respondedMailing 
                      0 </code></pre>
</div>
</div>
<p>Now age is the only variable with NAs left</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(donor) <span class="sc">+</span> <span class="fu">geom_histogram</span>(<span class="fu">aes</span>(<span class="at">x =</span> age)) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="PS4_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(donor)<span class="sc">+</span> <span class="fu">geom_boxplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> age))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="PS4_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>There are 20000 missing Values for age. However it is a variable we would like to keep. For that reason it is important that we keep The age distribution appears Bimodel. The disribution between the the modes apear very comparable. We will replace the NAs in age with the average. This will not affect the average and allow us to keep a lot more data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>donor <span class="ot">=</span> donor <span class="sc">%&gt;%</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">age =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(age),</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">median</span>(age, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>                      age))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(donor<span class="sc">$</span>respondedMailing)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
    0     1 
90569  4843 </code></pre>
</div>
</div>
<p>This is very disproportional. We will need to fix this.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>donor <span class="ot">&lt;-</span> donor <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">inHouseDonor =</span> <span class="fu">ifelse</span>(inHouseDonor <span class="sc">==</span> <span class="cn">TRUE</span>, <span class="dv">1</span>, <span class="dv">0</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mutate</span>(<span class="at">plannedGivingDonor =</span> <span class="fu">ifelse</span>(plannedGivingDonor <span class="sc">==</span> <span class="cn">TRUE</span>, <span class="dv">1</span>, <span class="dv">0</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="fu">mutate</span>(<span class="at">sweepstakesDonor =</span><span class="fu">ifelse</span>(sweepstakesDonor <span class="sc">==</span> <span class="cn">TRUE</span>, <span class="dv">1</span>,<span class="dv">0</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="fu">mutate</span>(<span class="at">P3Donor =</span><span class="fu">ifelse</span>(P3Donor <span class="sc">==</span> <span class="cn">TRUE</span>, <span class="dv">1</span>,<span class="dv">0</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Make some classification columns numerical</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">4</span>)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>samp <span class="ot">=</span> caret<span class="sc">::</span><span class="fu">createDataPartition</span>(donor<span class="sc">$</span>respondedMailing, <span class="at">p =</span> <span class="fl">0.7</span>, <span class="at">list =</span> <span class="cn">FALSE</span>)</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>train <span class="ot">=</span> donor[samp,]</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>test <span class="ot">=</span> donor[<span class="sc">-</span>samp,]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>seperate into training and test data</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>(train<span class="sc">$</span>respondedMailing) <span class="sc">%&gt;%</span> <span class="fu">table</span>() <span class="sc">%&gt;%</span> <span class="fu">prop.table</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>.
         0          1 
0.94922893 0.05077107 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>test<span class="sc">$</span>respondedMailing <span class="sc">%&gt;%</span> <span class="fu">table</span>() <span class="sc">%&gt;%</span> <span class="fu">prop.table</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>.
         0          1 
0.94926979 0.05073021 </code></pre>
</div>
</div>
<p>We will use smote to get our data more proportionally accurate</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Smote Version</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(performanceEstimation)</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">4959</span>)</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>smote_train <span class="ot">=</span> <span class="fu">smote</span>(respondedMailing <span class="sc">~</span> .,</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>                    <span class="at">data =</span> train)</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(smote_train<span class="sc">$</span>respondedMailing)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
    0     1 
13564 10173 </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>X <span class="ot">=</span> <span class="fu">as.matrix</span>(dplyr<span class="sc">::</span><span class="fu">select</span>(smote_train, <span class="sc">-</span>respondedMailing))</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>Y <span class="ot">=</span> smote_train<span class="sc">$</span>respondedMailing</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>cv_lasso <span class="ot">=</span> <span class="fu">cv.glmnet</span>(X, <span class="fu">as.double</span>(Y), <span class="at">type.measure =</span> <span class="st">"class"</span>,  <span class="at">family =</span><span class="st">"binomial"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(cv_lasso)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="PS4_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>There is a local minima at lamba = 3.6</p>
<p>building the tree</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>ctrl <span class="ot">=</span> caret<span class="sc">::</span><span class="fu">trainControl</span>(<span class="at">method =</span> <span class="st">"repeatedcv"</span>, <span class="at">number =</span> <span class="dv">5</span>, <span class="at">repeats =</span> <span class="dv">30</span>)</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>smote_tree <span class="ot">=</span> caret<span class="sc">::</span><span class="fu">train</span>(respondedMailing <span class="sc">~</span> ., </span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>             <span class="at">data =</span> smote_train, </span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>             <span class="at">method =</span> <span class="st">"rpart"</span>,</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>             <span class="at">metric =</span> <span class="st">"Kappa"</span>,</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>             <span class="at">trControl =</span> ctrl,</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>             <span class="at">tuneGrid =</span> <span class="fu">expand.grid</span>(<span class="at">cp =</span> <span class="fu">seq</span>(<span class="fl">0.0</span>, <span class="fl">0.1</span>, <span class="fl">0.005</span>)))</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(smote_tree)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="PS4_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>smote_tree</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CART 

23737 samples
   15 predictor
    2 classes: '0', '1' 

No pre-processing
Resampling: Cross-Validated (5 fold, repeated 30 times) 
Summary of sample sizes: 18990, 18991, 18989, 18989, 18989, 18989, ... 
Resampling results across tuning parameters:

  cp     Accuracy   Kappa    
  0.000  0.7690174  0.5215109
  0.005  0.7425551  0.4373467
  0.010  0.7201795  0.3832428
  0.015  0.7099674  0.3586786
  0.020  0.6961340  0.3261311
  0.025  0.6930543  0.3209928
  0.030  0.6672057  0.2565214
  0.035  0.6443722  0.1976412
  0.040  0.6443133  0.1973714
  0.045  0.6429020  0.1956744
  0.050  0.6335982  0.1670253
  0.055  0.6335982  0.1670253
  0.060  0.6330001  0.1654525
  0.065  0.6330001  0.1654525
  0.070  0.6330001  0.1654525
  0.075  0.6330001  0.1654525
  0.080  0.6324005  0.1622933
  0.085  0.6194265  0.1274436
  0.090  0.5714286  0.0000000
  0.095  0.5714286  0.0000000
  0.100  0.5714286  0.0000000

Kappa was used to select the optimal model using the largest value.
The final value used for the model was cp = 0.</code></pre>
</div>
</div>
<p>Best Kappa is at .9</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co">#rpart.plot::rpart.plot(smote_tree$finalModel)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>testing_mat <span class="ot">=</span> <span class="fu">data.matrix</span>(test)</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>lasso_test_class <span class="ot">=</span> <span class="fu">predict</span>(cv_lasso, testing_mat[,<span class="dv">1</span><span class="sc">:</span><span class="dv">15</span>], <span class="at">s=</span>cv_lasso<span class="sc">$</span>lambda.min)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>lasso_cm <span class="ot">=</span> <span class="fu">confusionMatrix</span>(<span class="at">data =</span> <span class="fu">as.factor</span>(<span class="fu">ifelse</span>(lasso_test_class <span class="sc">&gt;</span> <span class="fl">0.5</span>, <span class="dv">1</span>, <span class="dv">0</span>)), <span class="at">reference =</span> <span class="fu">as.factor</span>(testing_mat[,<span class="dv">15</span>]), <span class="at">positive =</span> <span class="st">"1"</span>)</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>lasso_cm</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Confusion Matrix and Statistics

          Reference
Prediction     0     1
         0 12744 15513
         1   175   190
                                          
               Accuracy : 0.4519          
                 95% CI : (0.4461, 0.4577)
    No Information Rate : 0.5486          
    P-Value [Acc &gt; NIR] : 1               
                                          
                  Kappa : -0.0013         
                                          
 Mcnemar's Test P-Value : &lt;2e-16          
                                          
            Sensitivity : 0.012100        
            Specificity : 0.986454        
         Pos Pred Value : 0.520548        
         Neg Pred Value : 0.451003        
             Prevalence : 0.548634        
         Detection Rate : 0.006638        
   Detection Prevalence : 0.012752        
      Balanced Accuracy : 0.499277        
                                          
       'Positive' Class : 1               
                                          </code></pre>
</div>
</div>
<p>At first glance is would appear that our lasso model did not perform very well. The accuracy is not good, the sensitivity is very low. However the main evaluater we care about is Pos Pred Value (precision). This tells us when the model predicts yes, how often is it correct. While a 52% chance of being correct does not sound good. It is signficantly more efficient than taking random guesses.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>smote_test_class <span class="ot">=</span> <span class="fu">predict</span>(smote_tree, <span class="at">newdata =</span> test, <span class="at">type=</span><span class="st">"raw"</span>)</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>smote_test_prob <span class="ot">=</span> <span class="fu">predict</span>(smote_tree, <span class="at">newdata =</span> test, <span class="at">type=</span><span class="st">"prob"</span>)[,<span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Tree Model</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>smote_cm <span class="ot">=</span> <span class="fu">confusionMatrix</span>(smote_test_class, test<span class="sc">$</span>respondedMailing, <span class="at">positive =</span> <span class="st">"1"</span>)</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>smote_cm</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Confusion Matrix and Statistics

          Reference
Prediction     0     1
         0 22734  1196
         1  4436   256
                                          
               Accuracy : 0.8032          
                 95% CI : (0.7986, 0.8078)
    No Information Rate : 0.9493          
    P-Value [Acc &gt; NIR] : 1               
                                          
                  Kappa : 0.0063          
                                          
 Mcnemar's Test P-Value : &lt;2e-16          
                                          
            Sensitivity : 0.176309        
            Specificity : 0.836732        
         Pos Pred Value : 0.054561        
         Neg Pred Value : 0.950021        
             Prevalence : 0.050730        
         Detection Rate : 0.008944        
   Detection Prevalence : 0.163930        
      Balanced Accuracy : 0.506520        
                                          
       'Positive' Class : 1               
                                          </code></pre>
</div>
</div>
<p>The Pos Pred Value of our tree was really not good. This model currently is too specific. This can be seen with a higher sensitivity meaning the rate of true positives captured by the program. This can be good because it means it will capture more positive responses, but with a lower precision will mean less efficient. Our tree model did significantly better.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">pty=</span><span class="st">"s"</span>)</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>lasso_roc <span class="ot">=</span> <span class="fu">roc</span>(testing_mat[,<span class="dv">16</span>], lasso_test_class, </span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>                     <span class="at">plot=</span><span class="cn">TRUE</span>, <span class="at">print.auc=</span><span class="cn">TRUE</span>, </span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>                     <span class="at">col=</span><span class="st">"green"</span>, <span class="at">lwd=</span><span class="dv">3</span>, <span class="at">legacy.axes=</span><span class="cn">TRUE</span>)</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>smote_roc <span class="ot">=</span> <span class="fu">roc</span>(test<span class="sc">$</span>respondedMailing <span class="sc">~</span> smote_test_prob,</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>                <span class="at">plot=</span><span class="cn">TRUE</span>, <span class="at">print.auc=</span><span class="cn">TRUE</span>, <span class="at">print.auc.y=</span><span class="fl">0.7</span>,</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>                <span class="at">col =</span> <span class="st">"black"</span>, <span class="at">lwd=</span><span class="dv">3</span>, <span class="at">legacy.axes=</span><span class="cn">TRUE</span>, <span class="at">add=</span><span class="cn">TRUE</span>)</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">"bottomright"</span>, <span class="at">legend=</span><span class="fu">c</span>(<span class="st">"Lasso Model"</span>, <span class="st">"Tree"</span>),</span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>       <span class="at">col =</span> <span class="fu">c</span>(<span class="st">"green"</span>, <span class="st">"black"</span>), <span class="at">lwd=</span><span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="PS4_files/figure-html/unnamed-chunk-27-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>This tells us that our Lasso Model appears to preform slightly better overall.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>lasso_explain <span class="ot">=</span> DALEX<span class="sc">::</span><span class="fu">explain</span>(<span class="at">model =</span> cv_lasso,</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>                               <span class="at">data =</span> testing_mat[,<span class="dv">1</span><span class="sc">:</span><span class="dv">15</span>],</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>                               <span class="at">y =</span> testing_mat[,<span class="dv">16</span>]<span class="sc">==</span><span class="st">"1"</span>,</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>                               <span class="at">type=</span><span class="st">'classification'</span>,</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>                               <span class="at">label=</span><span class="st">'Lasso Model'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Preparation of a new explainer is initiated
  -&gt; model label       :  Lasso Model 
  -&gt; data              :  28622  rows  15  cols 
  -&gt; target variable   :  28622  values 
  -&gt; predict function  :  yhat.cv.glmnet  will be used (  default  )
  -&gt; predicted values  :  No value for predict function target column. (  default  )
  -&gt; model_info        :  package glmnet , ver. 4.1.7 , task classification (  default  ) 
  -&gt; model_info        :  type set to  classification 
  -&gt; model_info        :  Model info detected classification task but 'y' is a logical . Converted to numeric.  (  NOTE  )
  -&gt; predicted values  :  numerical, min =  2.793412e-13 , mean =  0.4177559 , max =  0.8267794  
  -&gt; residual function :  difference between y and yhat (  default  )
  -&gt; residuals         :  numerical, min =  -0.825938 , mean =  0.5315139 , max =  1  
  A new explainer has been created!  </code></pre>
</div>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>lasso_perf <span class="ot">=</span> DALEX<span class="sc">::</span><span class="fu">model_performance</span>(lasso_explain, <span class="at">cutoff =</span> <span class="fl">0.5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">=</span> <span class="fu">plot</span>(lasso_perf, <span class="at">geom =</span> <span class="st">"prc"</span>)</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">=</span> <span class="fu">plot</span>(lasso_perf, <span class="at">geom =</span> <span class="st">"gain"</span>)</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>p1 <span class="sc">+</span> p2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="PS4_files/figure-html/unnamed-chunk-29-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>With a similar proportion as our current data 50,000 people would mean there are 2,535 people that would respond to mailing. With a precision of .52 this would mean about 1268 of those people of those would be successfully identified. This is significantly better than at random however there are still a lot of missed opportunities.</p>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>